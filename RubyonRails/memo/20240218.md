## Rspec導入

https://zenn.dev/tmasuyama1114/books/ab51fea5d5f659/viewer/rspec-introduction

`Gemfile`
```ruby
group :development, :test do
  # See https://guides.rubyonrails.org/debugging_rails_applications.html#debugging-with-the-debug-gem
  gem "debug", platforms: %i[ mri mingw x64_mingw ]
  # 追加！
  gem 'rspec-rails'
end
```

```bash
$ docker-compose exec ass_api bash
root@163e628e3781:/api# bundle install

Resolving dependencies...
~
Fetching rspec-core 3.13.0
Fetching rspec-mocks 3.13.0
Fetching rspec-expectations 3.13.0
Installing rspec-core 3.13.0
Installing rspec-mocks 3.13.0
Installing rspec-expectations 3.13.0
Fetching rspec-rails 6.1.1
Installing rspec-rails 6.1.1
Bundle complete! 8 Gemfile dependencies, 63 gems now installed.
Use `bundle info [gemname]` to see where a bundled gem is installed.
```

## 必要なファイル群を導入

```
root@163e628e3781:/api# bundle exec rails g rspec:install
      create  .rspec
      create  spec
      create  spec/spec_helper.rb
      create  spec/rails_helper.rb****
```

## 試しにコマンドを叩く
```
root@163e628e3781:/api# bundle exec rspec
No examples found.


Finished in 0.00032 seconds (files took 0.17547 seconds to load)
0 examples, 0 failures
```

## Factorybot追加
```
group :development, :test do
  # See https://guides.rubyonrails.org/debugging_rails_applications.html#debugging-with-the-debug-gem
  gem "debug", platforms: %i[ mri mingw x64_mingw ]
  gem 'rspec-rails'
  gem 'factory_bot_rails'
end
```

## `application.rb`を編集
自動で生成されるファイルを作成しないようにする
```ruby
require_relative "boot"

require "rails/all"

# Require the gems listed in Gemfile, including any gems
# you've limited to :test, :development, or :production.
Bundler.require(*Rails.groups)

module Api
  class Application < Rails::Application
    config.load_defaults 7.0
    
    config.api_only = true
    # 追加
    config.generators do |g|
      g.assets false
      g.helper false
      g.test_framework :rspec
        fixtures: false,
        view_specs: false,
        helper_specs: false,
        routing_specs: false
  end
end

```

## `bundle binstubs rspec-core`の実行
`bin/rspec spec/`でテストが実行できるるようになる
```
root@163e628e3781:/api# bundle binstubs rspec-core
root@163e628e3781:/api# bin/rspec spec/
No examples found.

Finished in 0.00021 seconds (files took 0.06641 seconds to load)
0 examples, 0 failures
```

## テストコードの作成
- `scaffold`...アプリケーションの雛形を作れる
  - https://zenn.dev/syu/articles/977155936eec5e

`location_post_spec.rb`
```ruby
require 'rails_helper'

RSpec.describe LocationPost, type: :model do
    
    pending "add some examples to (or delete) #{__FILE__}"
end
```

テスト実行
```
$ bin/rspec spec/models/location_post_spec.rb

LocationPost
  add some examples to (or delete) /api/spec/models/location_post_spec.rb (PENDING: Not yet implemented)

Pending: (Failures listed here are expected and do not affect your suite's status)

  1) LocationPost add some examples to (or delete) /api/spec/models/location_post_spec.rb
     # Not yet implemented
     # ./spec/models/location_post_spec.rb:5


Finished in 0.00207 seconds (files took 2.11 seconds to load)
1 example, 0 failures, 1 pending
```
 
## Rspec実行方法
### RSpec実行方法一覧
- $ bin/rspec spec/
  - 全テスト実行
- $ bin/rspec spec/models/
  - 指定フォルダ以下の全テスト実行
- $ bin/rspec spec/models/book_spec.rb
  - ファイル指定実行
- $ bin/rspec spec/models/book_spec.rb:5
  - ファイル指定+行数指定実行

前提として、RAILS_ENV=test なDBは事前に準備が必要です
最近のRailsでは便利機能が入って、development環境DBがあれば、test環境ではそのスキーマをコピーして自動生成します
DB生成コマンド $ RAILS_ENV=test bin/rails db:create db:migrate

## コントローラのテスト作成
https://qiita.com/KNR109/items/fe331069c4f958efbd96#get%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%81%AE%E3%83%86%E3%82%B9%E3%83%88
```ruby
require 'rails_helper'

describe 'GET /posts' do
  it '全件取得' do
    # spec/factories/posts.rbで定義したテストデータを10件複製(配列)
    FactoryBot.create_list(:location_post, 10)
    # /postsのエンドポイントへGETリクエスト
    get 'http://localhost:3001/api/v1/location_posts'
    # 返り値( render json: @posts)を変数に格納
    json = JSON.parse(response.body)

    # リクエスト成功を表す200が返ってきたか確認する。
    expect(response.status).to eq(200)
    # 10件のデータが返ってきているかを確認
    expect(json.length).to eq(10)
  end
end
```

```bash
root@163e628e3781:/api# bin/rspec spec/requests/location_posts_controller_spec.rb

GET /posts
  全件取得

Finished in 0.14586 seconds (files took 2.01 seconds to load)
1 example, 0 failures
```

rails_helper.rb設定
```

```


