# コンテナ化されるアプリケーションに必要な性質

## アプリケーションの実装・アーキテクチャに関するトピック

### ステートレスな状態を維持する
- キャッシュやセッション情報はアプリにもたない
  - どのコンテナでも処理ができるようにしてスケーラビリティ、UIUXを向上させる
  - アプリケーション内にキャッシュを持つとしても暖気不要な軽量キャッシュのみにとどめる
- ステートレスなアプリケーションが必要な状況
  - スケールイン、スケールアウト時
  - コンテナの障害時

### スケールアウト可能なアーキテクチャ
- スケールアップではなくスケールアウトで性能向上をしやすく
  - 平行スケールと垂直スケールの話  
  - マイクロサービスアーキテクチャの採用
    - サービス間通信を行い、細かい単位でスケールアウトできるように
    - コンテナをデプロイするVMの枠には限りがある、そのためできるだけ細かいコンテナが良い
  - イベント駆動アーキテクチャの採用
  - ステートレスな状態を維持する

### 設定は外部から注入できるようにする
- コンテナ(プロセス)の挙動を容易に外部から変えられるようにする
  - DBの接続情報
  - アプリケーションの並列数
  - STG/PRDなどの環境
- 設定ファイルや環境変数は基本的にコンテナイメージに含めない
- STGとPRDで同じコンテナイメージを利用する
- 環境変数で切り替える
  - 設定項目が少ない場合に有効
- 設定ファイルを渡して切り替える
  - 設定項目が多い場合や、設定に階層構造を持つ場合に適切
- 環境変数と設定ファイルを併用する
  - オーバーライドする順序に注意して設定する
 
### ログは標準出力に構造化ログで出力
- アプリケーションのログは標準出力に設定し、送り先や保存先の設定は基盤側で行う
  - ファイル書き出しではなく標準出力へ
- 構造化ログで出力する
  - JSONLなどの構造化ログで出力し、転送先のログ基盤などでパースしやすくする
- 重要度が高いものは永続ストレージを利用する
  - アプリケーションの突然停止にも対応
  - バックエンドとの統合は個別に設定が必要
- アプリケーションからの直接転送
  - SDKなどを用いて実装
  -  配信ルールなどの変更にリビルドやアプリケーション停止が必要な可能性
  -  突然の停止時に転送しきれない可能性

### いつでも容易に停止できるようにする(廃棄用意性)
- コンテナは短命を意識していつでも停止できるようにする(運用をブロックしない)
  - コンテナのイメージのアップグレード、ノードのアップグレードやメンテナンスによる停止
- コンテナは短い時間で停止できる状態にする
  - 既に受けているリクエストを処理しきってから終了する
  - 1リクエストに長時間かかる場合は非同期なアーキテクチャを検討する
- ログを書き出してから終了する
- k8sではデフォルト30秒でSIGKILLでコンテナ強制停止
- 一部マネージドk8sではノード更新時に最長数分でVM強制停止

### 停止時に処理する内容の一例
- 受信リクエストを正常に処理する
  - 数秒程度リクエストを受信
- 全スレッドの完了を待機
  - ログを書き出す
 
### SIGTERMシグナルをハンドリングする
- PIDはシグナルハンドラがない場合にSIGTERMでプロセスを終了しない(PID1問題)
  - PD1は使わない
  - PD1は特別なinitプロセスが起動するため

### 軽量initを利用してSIGTERMを伝搬する
- 通常通りPID1がinitになるため、アプリケーションが従来通りに停止する
- initがない場合ゾンビプロセスが発生するが軽量initでは発生しない
- e.g. tini / dumb-init / docker-init

### コンテナ上には単一のプロセスのみ起動
- コンテナ単位で機能を疎結合にする
- アプリケーションをシンプル・軽量に保つ
- 再利用性を高める設計をする

### 停止処理・プロセス障害のフローが煩雑化
- プロセスを束ねる親プロセス経由で管理
  - 停止時には複数プロセス全体を正常に停止
- 基本的に疎結合にたもち、コンテナランタイムやコンテナ基盤に任せる

### ヘルスチェック用のエンドポイント
- 外部からアプリケーションの状態を確認できるようにヘルスチェック用エンドポイントを実装
  - トラフィックの転送の可否判断、アプリケーションがハングしていないかの判断
  - エンドポイントでのチェックが難しい場合はコマンドでのチェックの可能
  - 過剰なヘルスチェックへの注意が必要

### アプリケーションの状態を可観測に
- オープンソースな仕様で実装する
  - SDKを利用して用意に実装可能
  - 各種Saas/クラウドベンダー側も対応
- アプリケーションの状態を適切に観測する
  - キャッシュヒット率、Continueの数
 
### 起動時にアプリをダウンロードしない
- ダウンロードする場合のデメリット
  - 起動時間の上昇
  - コンテナイメージのキャッシュが効かない
  - ダウンロード失敗時のハンドリングが煩雑
  - ダウンロードファイルが保証されていないことの保証

### コンテナイメージにアプリケーション・静的ファイルを含んでバージョン管理する
- レイヤーの仕組みによりデータ量はほぼ同じ
- 
